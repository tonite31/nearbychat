<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta name='viewport' content='width=device-width' />  
<meta charset="UTF-8" />  	
<link rel="stylesheet" href="@{js/libs/bootstrap/bootstrap.min.css}">
<link rel="stylesheet" href="@{css/index.css}">
<link rel="stylesheet" href="@{css/component.css}">

<script src="@{js/libs/jquery/jquery-3.1.1.min.js}"></script>
<script src="@{js/libs/jquery/jquery.form.js}"></script>
<script src="@{js/libs/common.js}"></script>

<style>
#subject small
{
	font-size: 15px;
	color: #777;
}

#point-container
{
	margin: 10px 0;
	border: 1px solid #ddd;
	padding: 15px;
}

#comment-container
{
	margin-top: 30px 0;
	margin-bottom: 100px;
}

#comment-container .panel
{
	padding: 15px;
	font-size: 15px;
	margin-bottom: 5px;
}

.point-average
{
	font-size: 17px;
}

.comment-author small, .comment-author .modify, .comment-author .delete
{
	font-weight: normal;
	font-size: 12px;
	float: right;
	margin-top: 5px;
	margin-right: 5px;
}

.comment-author .modify, .comment-author .delete
{
	cursor: pointer;
}

.comment-author .modify:HOVER, .comment-author .delete:HOVER
{
	text-decoration: underline;
}

.comment-author, .point-average
{
	display: block;
	padding-bottom: 10px;
	
	border-bottom: 1px solid #ddd;
	font-weight: bold;
}

.comment-content, .point-person
{
	display: block;
	padding-top: 10px;
}

#write-point 
{
	padding: 10px 0;
	border-top: 1px solid #ddd;
	display: none;
}

#write-point select
{
	padding: 10px;
	vertical-align: middle;
}

.point-list
{
	padding: 20px 0;
}

#save-comment, #comment-container .input-group-addon
{
	cursor: pointer;
}

#save-comment:HOVER, #comment-container .input-group-addon:hover
{
	font-weight: bold;
}

.point-fold
{
	display: block;
	padding-top: 10px;
	cursor: pointer;
}
.point-fold:HOVER
{
	text-decoration: underline;
}
</style>

<template id="comment-item-template">
<div class="panel panel-default">
	<span class="comment-author">{author} {function} <small>{published_date}</small></span>
	<span class="comment-content">{content}</span>
</div>
</template>

<script>
var id = getParameterByName('_id');
$(document).ready(function()
{
	$('#update').get(0).href += id;
	
	$.ajax({url: '/api/posts/' + id}).done(function(data)
	{
		if(!data.isOwn)
		{
			$('#update').remove();
			$('#delete').remove();
		}
		
		$('#content').html(data.content);
		$('#subject').html(data.subject + ' <small>' + data.author + '</small>');
	}).fail(function(error)
	{
		$('.container').html(error);
	});
	
	$('#delete').on('click', function()
	{
		if(confirm('정말 삭제하시겠습니까?'))
		{
			$.ajax({url : '/api/posts/' + id, type: 'delete'}).done(function()
			{
				location.href = '/index';
			}).fail(function(error)
			{
				$('.container').html(error);
			});
		}
	});
	
	bindComments();
	bindPoints();	
	
	$('#save-comment').on('click', function()
	{
		var content = $(this).prev().val();
		if(!content)
		{
			alert('덧글을 입력해주세요');
			return;
		}
		
		//ajax call
		$.ajax({url : '/api/comments', type: 'post', data : {postId : id, content : content}}).done(function(data)
		{
			$('#comment-container .panel').remove();
			bindComments();
			$('#write-comment input').val('');
		}).fail(function(error)
		{
			alert('작성실패');
			console.error(error);
		});
	});
	
	$('.point-fold').on('click', function()
	{
		$(this).hide().next().show();	
	});
	
	$('#save-point').on('click', function()
	{
		var point = $('#write-point select').val();
		$.ajax({url : '/api/points/', type: 'put', data : {postId : id, point : point}}).done(function(data)
		{
			bindPoints();
		}).fail(function(error)
		{
			alert('입력실패');
			console.error(error);
		});
	});
});

function bindPoints()
{
	$('.point-list').html('');
	$.ajax({url : '/api/points/' + id}).done(function(data)
	{
		if(data.length > 0)
		{
			var sum = 0;
			for(var i=0; i<data.length; i++)
			{
				$('.point-list').append('<div class="point-person">' + data[i].author + ' - ' + data[i].point + '점</div>');
				sum += data[i].point;
			}
			
			var star = '';
			var average = sum / data.length;
			console.log('평균 : ', average, average/2);
			
			var i=1;
			for(; i<=average/2; i++)
			{
				star += '★';
			}
			
			for(; i<=5; i++)
			{
				star += '☆';
			}
			
			$('.point-average').html(star + ' (' + average + '점)');
		}
		else
		{
			$('.point-average').html('☆☆☆☆☆ (0점)');
			$('.point-list').html('입력된 점수가 없습니다');
		}
	}).fail(function(error)
	{
		$('.container').html(error);
	});	
}

function bindComments()
{
	$.ajax({url : '/api/comments/' + id}).done(function(data)
	{
		var template = $('#comment-item-template').html();
		
		if(data.length > 0)
		{
			var html = '';
			for(var i=0; i<data.length; i++)
			{
				console.log("머지 : ", data[i].isOwn);
				var t = template.replace('{content}', data[i].content).replace('{author}', data[i].author).replace('{published_date}', getDate(data[i].published_date));
				if(!data[i].isOwn)
				{
					t = t.replace('{function}', '');
				}
				else
				{
					t = t.replace('{function}', '<span class="delete" data-id="' + data[i]._id + '">삭제</span> <span class="modify" data-id="' + data[i]._id + '">수정</span>');
				}
					
				html += t;
			}
			
			$('#comment-container').prepend(html);
			
			$('.comment-author .modify').on('click', function()
			{
				var _id = $(this).attr('data-id');
				var content = $(this).parent().parent().find('.comment-content');
				
				var text = content.html();
				content.html('<div class="input-group"><input type="text" class="form-control" placeholder="덧글입력" aria-describedby="basic-addon2" value="' + text + '"><span class="input-group-addon">저장</span></div>');
				content.find('input').focus();
				content.find('span').on('click', function()
				{
					var value = $(this).prev().val();
					$.ajax({url : '/api/comments/' + _id, type: 'put', data: {content : value}}).done(function(result)
					{
						content.html(value);
					}).fail(function(error)
					{
						alert('작성실패');
						console.error(error);
					});
				});
			});
			
			$('.comment-author .delete').on('click', function()
			{
				var _id = $(this).attr('data-id');
				var content = $(this).parent().parent().find('.comment-content');
				
				if(confirm('삭제하시겠습니까?'))
				{
					$.ajax({url : '/api/comments/' + _id, type: 'delete'}).done(function(result)
					{
						content.parent().remove();
					}).fail(function(error)
					{
						alert('삭제실패');
						console.error(error);
					});
				}
			});
		}
		else
		{
			var e = $(template);
			e.html('덧글이 없습니다');
			$('#comment-container').prepend(e);
		}
	}).fail(function(error)
	{
		$('.container').html(error);
	});
}

function getDate(d)
{
	var date = new Date(d);
	var year = date.getFullYear();
	var months = date.getMonth() + 1;
	var dayOfMonth = date.getDate();
	var hour = date.getHours();
	var min = date.getMinutes();
	var sec = date.getSeconds();
	
	months = months > 10 ? months : '0' + months;
	dayOfMonth = dayOfMonth > 10 ? dayOfMonth : '0' + dayOfMonth;
	hour = hour > 10 ? hour : '0' + hour;
	min = min > 10 ? min : '0' + min;
	sec = sec > 10 ? sec : '0' + sec;
	
	return year + '-' + months + '-' + dayOfMonth + ' ' + hour + ':' + min + ':' + sec;
}
</script>

</head>
<body>
<div class="container" style="margin-top: 50px;">
	<h1 id="subject"></h1>
	<div style="margin: 20px 0; text-align: right;">
		<a href="/write?_id=" class="btn btn-default" id="update">수정</a>
		<button type="button" class="btn btn-danger" id="delete">삭제</button>
		<a href="/" class="btn btn-default">목록으로</a>
	</div>
	<div id="content"></div>
	<div id="point-container">
		<div class="point-average"></div>
		<div class="point-list"></div>
		<span class="point-fold">점수입력</span>
		<div id="write-point">
			<select>
				<option value="10" selected>10점</option>
				<option value="9">9점</option>
				<option value="8">8점</option>
				<option value="7">7점</option>
				<option value="6">6점</option>
				<option value="5">5점</option>
				<option value="4">4점</option>
				<option value="3">3점</option>
				<option value="2">2점</option>
				<option value="1">1점</option>
				<option value="0">0점</option>
			</select>
			<button type="button" class="btn btn-default" id="save-point">점수입력</button>
			<small>다시 입력하면 수정됩니다.</small>
		</div>
	</div>
	<div id="comment-container">
		<div id="write-comment">
			<div class="input-group">
				<input type="text" class="form-control" placeholder="덧글입력" aria-describedby="basic-addon2">
				<span class="input-group-addon" id="save-comment">저장</span>
			</div>
		</div>
	</div>
</div>
</body>
</html>